<script type="module">
    import * as THREE from '/static/js/three.module.js';
    import { GLTFLoader } from '/static/js/GLTFLoader.js';
    import { OrbitControls } from '/static/js/OrbitControls.js';
    import { createFingerGUI } from './static/js/fingergui.js';

    // --- 场景/相机/渲染器/光源 ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeeeeee);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0.5, 0.1, 0);
    // camera.lookAt(100, 0, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(-0.3, 0, 0);
    controls.update();
    scene.add(new THREE.DirectionalLight(0xffffff, 1));
    scene.add(new THREE.AmbientLight(0x404040, 1.5));

    // --- 加载 GLB ---
    const loader = new GLTFLoader();
    loader.load('/static/left_robot.glb', gltf => {
        const model = gltf.scene;
        scene.add(model);

        // 建立骨骼映射
        const bones = {};
        model.traverse(obj => {
            if (obj.type === "Bone") bones[obj.name] = obj;
        });
        // console.log(bones);
        // 手指映射
        const fingerMap = {
            index: ["骨骼001", "骨骼002", "骨骼003"],
            middle: ["骨骼001_1", "骨骼002_1", "骨骼003_1"],
            ring: ["骨骼001_2", "骨骼002_2", "骨骼003_2"],
            pinky: ["骨骼001_3", "骨骼002_3", "骨骼003_3"],
            thumb: ["骨骼001_4", "骨骼002_4", "骨骼003_4"]
        };

        // 创建 GUI
        createFingerGUI(bones, fingerMap);

        // 可视化骨骼
        const helper = new THREE.SkeletonHelper(model);
        scene.add(helper);
    });

    // --- 动画循环 ---
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // --- 窗口自适应 ---
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>